<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Sakila : ì£¼ì†Œ ê´€ë¦¬</title>
	<!-- ìŠ¤íƒ€ì¼ì‹œíŠ¸ css íŒŒì¼ import -->
	<link rel="stylesheet" href="../style/hi.css">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
	<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
</head>
<body>
	<div class="columns" style="margin:0; height: 100%">
		<!-- ë©”ë‰´ -->
		<div class="column is-2 notification card is-peachy" style="margin:0;">
			<section class="section">
			    <component v-bind:is="testCompo"></component>
			</section>
		</div>
		<!-- ë‚´ìš© -->
		<div class="column">
			 <nav class="breadcrumb notification is-lighter-peachy" aria-label="breadcrumbs">
			  <ul>
			    <li><a href="#">ADDRESS</a></li>
			    <li class="is-active"><a href="#" aria-current="page">ì£¼ì†Œê´€ë¦¬</a></li>
			  </ul>
			 </nav>
			 <section class="is-content">
		   	  <h1 class="title is-4 is-spaced">ğŸ  ì£¼ì†Œ ê´€ë¦¬</h1>
			  <h1 class="subtitle is-6">êµ­ê°€/ë„ì‹œ ì„ íƒ ê²€ìƒ‰</h1>
				êµ­ê°€
				<div class="select">
					<select v-model="countryId" @change="getCity">
						<option selected value="0">êµ­ê°€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</option>
						<option v-for="item in country" :value="item.countryId">{{ item.country }}</option>
					</select>
				</div>
				&nbsp;ë„ì‹œ
				<div class="select">
					<select v-model="cityId" @change="putCityId">
						<option selected value="0">
							<template v-if="countryId === 0">êµ­ê°€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</template>
							<template v-else>ë„ì‹œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</template>
						</option>
						<template v-if="countryId != 0"> 
							<option v-for="item in city" :value="item.cityId">{{ item.city }}</option>
						</template>
					</select>
				</div>	
				<button type="button" class="button" @click="getAddressListByCity"> ê²€ìƒ‰ </button>
				<a href="#" onclick="getAddressList(1)">ì „ì²´ ë³´ê¸°</a>
			  <hr>
			  <h1 class="title is-5 has-text-centered is-danger">ê²€ìƒ‰ ê²°ê³¼</h1>
			  <table class="table is-hoverable is-bordered is-fullwidth">
					<thead>
						<tr>
							<th class="has-text-centered" width="5%">ë²ˆí˜¸</th>
							<th class="has-text-centered">ì£¼ì†Œ</th>
							<th class="has-text-centered">ìƒì„¸ì£¼ì†Œ</th>
							<th class="has-text-centered" width="5%">ì§€êµ¬</th>
							<th class="has-text-centered" width="10%">ì§€ì—­</th>
							<th class="has-text-centered" width="8%">ìš°í¸ë²ˆí˜¸</th>
							<th class="has-text-centered" width="8%">ì „í™” ë²ˆí˜¸</th>
							<th class="has-text-centered" width="13%">ë§ˆì§€ë§‰ ìˆ˜ì •</th>
						</tr>
					</thead>
					<tbody>
						<tr v-for="item in json">
							<td>{{item.addressId}}</td>
							<td>{{item.address}}</td>
							<td>{{item.address2}}</td>
							<td>{{item.city.cityId}}</td>
							<td>{{item.district}}</td>
							<td>{{item.postalCode}}</td>
							<td>{{item.phone}}</td>
							<td>{{item.lastUpdate}}</td>
						</tr>
					</tbody>
				</table>
				
				<button type="button" class="button" @click="prevBtn">ì´ì „</button>
				<button type="button" class="button" @click="nextBtn">ë‹¤ìŒ</button>
			<hr>
		  </section>
		  <component :is="footer"></component>
		</div><!-- ë‚´ìš© ë -->
	</div><!-- columns ë -->
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="../js/sakilaCRM.js"></script>
<script>
var currentPage = 1;
var lastPage = 0;
var vm = new Vue({
	el: ".columns",
	data: {
		json:[{}],
		country : [{}], 
		countryId : 0,
		city : [{}],
		cityId : 0,
		testCompo: Menu,
		footer : Footer,
	},
	mounted() {
		console.log("getting Info! ");
		console.log("get country Count");
		// country ëª©ë¡ ì¶œë ¥
		$.ajax({
			url:"/sakila/addreess/SelectAddressCount", 
			method: "POST",
			success : function(json){
				lastPage = parseInt(json/10);
				if(json%10!=0)
					lastPage++;
				console.log("lastPage", lastPage);
			}
		});
		
		// country ëª©ë¡ ì¶œë ¥
		$.ajax({
			url:"/sakila/address/SelectCountryListAll", 
			method: "POST",
			success : function(json){
				vm.country = json;
				console.log("json", json);
				console.log("vm.country", vm.country);
			}
		});	
		getAddressList();
	},
	methods: {
		getAddressListByCity : function(){
			console.log("cityId: ", this.cityId);
			currentPage = 1;
			if(this.cityId === 0){
				alert("ë„ì‹œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”");
				return;
			}
			console.log("getting address list...")
			
			$.ajax({
				url: "/sakila/address/SelectAddressListByCity",
				method: "POST", 
				data: {currentPage : currentPage, cityId: vm.cityId},
				success: function(json){
					vm.json = json;
					console.log("vm.json ", vm.json);
					lastPage = (json.length%10!=0) ? parseInt(json.length/10)+1 : parseInt(json.length/10);
				}
			});
		},
		putCityId : function(){
			vm.cityId = this.cityId;
			console.log("this cityId: ", vm.cityId);
		},
		getCity : function(){
			console.log("get city list");
			vm.cityId = 0;
			console.log("this.countryId: ", this.countryId);
			$.ajax({
				url:"/sakila/address/SelectCityListByCountry", 
				method: "POST",
				data : {"countryId" : this.countryId},
				success : function(json){
					vm.city = json;
				}
			});
		},
		nextBtn : function(){
			if(currentPage >= lastPage){
				alert("ë§ˆì§€ë§‰ í˜ì´ì§€ì…ë‹ˆë‹¤.")
				return;
			}
			currentPage ++;
			if(vm.cityId===0){
				getAddressList(0);
				return;
			}
			this.getAddressListByCity();
		},
		prevBtn : function(){
			if(currentPage <= 1){
				alert("ì²« í˜ì´ì§€ ì…ë‹ˆë‹¤.")
				return;
			}
			currentPage --;
			if(vm.cityId===0){
				getAddressList(0);
				return;
			}
			this.getAddressListByCity();
		},
	},
});

function getAddressList(flag){ 
	console.log(flag);
	// country count
	$.ajax({
		url:"/sakila/addreess/SelectAddressCount",
		method: "POST",
		success : function(json){
			console.log("getAddressListì—ì„œ last Page ë°”ê¿ˆ" ,json);
			if(flag === 1){ 
				currentPage = 1;
				vm.cityId = 0;
				console.log("vm.cityId", vm.cityId); 
				lastPage = parseInt(json/10);
				if(json%10!=0){
					lastPage++;
				}
				console.log("lastPage", lastPage); 
			}
		}
	});	
	console.log("get getAddressList");
	// ì²˜ìŒ í˜ì´ì§€ ì—´ì—ˆì„ ë•Œ address ëª©ë¡ ì¶œë ¥
	$.ajax({
		url: "/sakila/address/SelectAddressList",
		method: "POST",
		data : { currentPage : currentPage},
		success : function(json){
			vm.json = json;
			console.log("vm.json: ", vm.json , ", json: ",json);		
		}
	});
}

</script>
</html>